<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>InstaBridge — Reports</title>
    <style>
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; margin: 24px; }
      .card { max-width: 720px; border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; }
      button { padding: 10px 12px; border-radius: 10px; border: 1px solid #111827; background: #111827; color: white; cursor: pointer; }
      button:disabled { opacity: 0.6; cursor: not-allowed; }
      .muted { color: #6b7280; font-size: 14px; }
      .row { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 12px; }
      label { font-size: 13px; color: #374151; display: flex; flex-direction: column; gap: 6px; }
      input, select { padding: 8px 10px; border-radius: 10px; border: 1px solid #d1d5db; min-width: 140px; }
      .chk { flex-direction: row; align-items: center; }
      ul { margin-top: 12px; }
      li { padding: 4px 0; }
      code { background: #f3f4f6; padding: 2px 6px; border-radius: 6px; }
      .err { color: #b91c1c; white-space: pre-wrap; }
    </style>
  </head>
  <body>
    <div class="card">
      <div class="row" style="justify-content: space-between; align-items: center; margin-top: 0;">
        <div class="muted"><b>Reports</b></div>
        <div class="muted"><a href="/settings">Settings</a></div>
      </div>
      <h2>Not following you back</h2>
      <p class="muted">Filters require fetching account stats; first run can take a bit. Results are cached in <code>user_cache.json</code>.</p>

      <div class="row">
        <label>Min followers
          <input id="minFollowers" type="number" placeholder="e.g. 0" />
        </label>
        <label>Max followers
          <input id="maxFollowers" type="number" placeholder="e.g. 5000" />
        </label>
        <label>Username contains
          <input id="q" type="text" placeholder="e.g. music" />
        </label>
        <label>Sort by
          <select id="sortBy">
            <option value="followers" selected>followers</option>
            <option value="username">username</option>
          </select>
        </label>
        <label>Sort dir
          <select id="sortDir">
            <option value="desc" selected>desc</option>
            <option value="asc">asc</option>
          </select>
        </label>
        <label>Max profiles to inspect
          <input id="maxProfiles" type="number" value="200" />
        </label>
        <label>Offset
          <input id="offset" type="number" value="0" />
        </label>
        <label>Limit
          <input id="limit" type="number" value="50" />
        </label>
        <label>Max new stats to fetch
          <input id="maxFetch" type="number" value="25" />
        </label>
        <label class="chk">
          <input id="cacheOnly" type="checkbox" checked />
          cache-only (fast)
        </label>
        <label class="chk">
          <input id="refreshFollow" type="checkbox" />
          refresh follow lists (slow)
        </label>
        <label class="chk">
          <input id="includePrivate" type="checkbox" checked />
          include private
        </label>
        <label class="chk">
          <input id="includeVerified" type="checkbox" checked />
          include verified
        </label>
      </div>

      <button id="btn" onclick="run()" style="margin-top: 12px;">Fetch list</button>
      <div class="row" style="align-items: center;">
        <button id="warmBtn" onclick="warm()" style="margin-top: 12px; background: #0f766e; border-color: #0f766e;">Warm cache (show progress)</button>
        <button id="warmResetBtn" onclick="warmReset()" style="margin-top: 12px; background: white; color: #111827;">Reset progress</button>
      </div>
      <div style="margin-top: 10px;">
        <div class="muted">Warm progress (100% = stats fetched/checked for all not-following-back users)</div>
        <progress id="warmProg" value="0" max="100" style="width: 100%; height: 16px;"></progress>
        <div id="warmText" class="muted" style="margin-top: 6px;"></div>
      </div>
      <div id="status" class="muted" style="margin-top: 12px;"></div>
      <div id="error" class="err" style="margin-top: 12px;"></div>
      <ul id="list"></ul>
    </div>

    <script>
      async function run() {
        const btn = document.getElementById('btn');
        const status = document.getElementById('status');
        const error = document.getElementById('error');
        const list = document.getElementById('list');
        const minFollowers = document.getElementById('minFollowers').value;
        const maxFollowers = document.getElementById('maxFollowers').value;
        const q = document.getElementById('q').value;
        const sortBy = document.getElementById('sortBy').value;
        const sortDir = document.getElementById('sortDir').value;
        const maxProfiles = document.getElementById('maxProfiles').value;
        const offset = document.getElementById('offset').value;
        const limit = document.getElementById('limit').value;
        const maxFetch = document.getElementById('maxFetch').value;
        const cacheOnly = document.getElementById('cacheOnly').checked;
        const refreshFollow = document.getElementById('refreshFollow').checked;
        const includePrivate = document.getElementById('includePrivate').checked;
        const includeVerified = document.getElementById('includeVerified').checked;

        error.textContent = "";
        list.innerHTML = "";
        btn.disabled = true;
        status.textContent = "Fetching…";
        try {
          const params = new URLSearchParams();
          if (minFollowers) params.set('min_followers', minFollowers);
          if (maxFollowers) params.set('max_followers', maxFollowers);
          if (q) params.set('q', q);
          params.set('sort_by', sortBy);
          params.set('sort_dir', sortDir);
          if (maxProfiles) params.set('max_profiles', maxProfiles);
          if (offset) params.set('offset', offset);
          if (limit) params.set('limit', limit);
          if (maxFetch) params.set('max_fetch_missing', maxFetch);
          params.set('cache_only', cacheOnly ? '1' : '0');
          params.set('refresh_follow_cache', refreshFollow ? '1' : '0');
          params.set('include_private', includePrivate ? '1' : '0');
          params.set('include_verified', includeVerified ? '1' : '0');

          const res = await fetch('/api/not-following-back?' + params.toString());
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Request failed');
          status.textContent = `Found ${data.count} (this page).`;
          for (const u of data.users) {
            const li = document.createElement('li');
            const followers = (u.followers === null || u.followers === undefined) ? '?' : u.followers;
            const priv = u.is_private ? 'private' : 'public';
            const ver = u.is_verified ? ', verified' : '';
            li.textContent = `${u.username} — followers: ${followers} (${priv}${ver})`;
            list.appendChild(li);
          }
        } catch (e) {
          status.textContent = "";
          error.textContent = String(e);
        } finally {
          btn.disabled = false;
        }
      }

      async function warmReset() {
        const warmText = document.getElementById('warmText');
        const warmProg = document.getElementById('warmProg');
        warmText.textContent = "Resetting…";
        try {
          const res = await fetch('/api/warm-cache/reset', { method: 'POST' });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || 'Reset failed');
          warmProg.value = 0;
          warmText.textContent = "Reset done.";
        } catch (e) {
          warmText.textContent = String(e);
        }
      }

      async function warm() {
        const warmBtn = document.getElementById('warmBtn');
        const warmResetBtn = document.getElementById('warmResetBtn');
        const warmText = document.getElementById('warmText');
        const warmProg = document.getElementById('warmProg');
        const refreshFollow = document.getElementById('refreshFollow').checked;

        warmBtn.disabled = true;
        warmResetBtn.disabled = true;
        warmText.textContent = "Warming…";
        try {
          while (true) {
            const params = new URLSearchParams();
            params.set('chunk_size', '25');
            if (refreshFollow) params.set('refresh_follow_cache', '1');
            const res = await fetch('/api/warm-cache/step?' + params.toString());
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || 'Warm step failed');

            if (data.rate_limited) {
              const s = data.retry_after_s || 600;
              warmText.textContent = `Instagram rate limited. Please wait ~${s}s, then click "Warm cache" again.`;
              break;
            }

            warmProg.value = data.percent || 0;
            warmText.textContent = `Progress: ${data.processed}/${data.total} (${data.percent}%). Newly fetched this step: ${data.newly_fetched}.`;

            if (data.done) break;
            // Let the UI repaint between steps.
            await new Promise(r => setTimeout(r, 50));
          }
          warmText.textContent += " Done.";
        } catch (e) {
          warmText.textContent = String(e);
        } finally {
          warmBtn.disabled = false;
          warmResetBtn.disabled = false;
        }
      }
    </script>
  </body>
</html>
